{% extends "base.html" %}
{% load static %}

{% block title %}Make Picks - Baseball Pick 4{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1>Make Your Weekly Picks</h1>
            <p class="lead">Week {{ week.week_number }} - {{ week.season_year }}</p>
        </div>
    </div>

    <!-- Countdown Timer -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-info" id="countdown-alert">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-clock"></i>
                        <strong>Deadline:</strong> {{ week.deadline_utc|date:"M d, Y g:i A" }} UTC
                    </div>
                    <div>
                        <strong>Time Remaining:</strong>
                        <span id="countdown-timer" class="badge bg-primary fs-6">
                            Calculating...
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form method="post">
        {% csrf_token %}

        <!-- 2 Hits Category -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-baseball-ball"></i>
                    2 Hits (2B)
                </h5>
                <small>Pick a batter who will get 2+ hits in any game</small>
            </div>
            <div class="card-body">
                <!-- Search Box -->
                <div class="mb-3">
                    <input type="text" 
                           class="form-control" 
                           id="search_2b" 
                           placeholder="ðŸ” Search by player name or team..."
                           autocomplete="off">
                    <small class="text-muted">Type to filter players â€¢ <span id="count_2b">{{ batters.count }} available</span></small>
                </div>
                
                <select name="pick_2b" id="pick_2b" class="form-select form-select-lg" required>
                    <option value="">-- Select a Batter --</option>
                    {% for player in batters %}
                        <option value="{{ player.id }}" 
                                data-name="{{ player.full_name|lower }}"
                                data-team="{{ player.team_name|lower }}"
                                {% if existing_picks.pick_2b == player.id %}selected{% endif %}>
                            {{ player.full_name }} - {{ player.team_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Home Run Category -->
        <div class="card mb-3">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="fas fa-rocket"></i>
                    Home Run (HR)
                </h5>
                <small>Pick a batter who will hit a home run</small>
            </div>
            <div class="card-body">
                <!-- Search Box -->
                <div class="mb-3">
                    <input type="text" 
                           class="form-control" 
                           id="search_hr" 
                           placeholder="ðŸ” Search by player name or team..."
                           autocomplete="off">
                    <small class="text-muted">Type to filter players â€¢ <span id="count_hr">{{ batters.count }} available</span></small>
                </div>
                
                <select name="pick_hr" id="pick_hr" class="form-select form-select-lg" required>
                    <option value="">-- Select a Batter --</option>
                    {% for player in batters %}
                        <option value="{{ player.id }}"
                                data-name="{{ player.full_name|lower }}"
                                data-team="{{ player.team_name|lower }}"
                                {% if existing_picks.pick_hr == player.id %}selected{% endif %}>
                            {{ player.full_name }} - {{ player.team_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Starting Winning Pitcher Category -->
        <div class="card mb-3">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-trophy"></i>
                    Starting Winning Pitcher (SWP)
                </h5>
                <small>Pick a starting pitcher who will get the win</small>
            </div>
            <div class="card-body">
                <!-- Search Box -->
                <div class="mb-3">
                    <input type="text" 
                           class="form-control" 
                           id="search_swp" 
                           placeholder="ðŸ” Search by player name or team..."
                           autocomplete="off">
                    <small class="text-muted">Type to filter players â€¢ <span id="count_swp">{{ pitchers.count }} available</span></small>
                </div>
                
                <select name="pick_swp" id="pick_swp" class="form-select form-select-lg" required>
                    <option value="">-- Select a Pitcher --</option>
                    {% for player in pitchers %}
                        <option value="{{ player.id }}"
                                data-name="{{ player.full_name|lower }}"
                                data-team="{{ player.team_name|lower }}"
                                {% if existing_picks.pick_swp == player.id %}selected{% endif %}>
                            {{ player.full_name }} - {{ player.team_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Save Category -->
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-shield-alt"></i>
                    Save (S)
                </h5>
                <small>Pick a relief pitcher who will record a save</small>
            </div>
            <div class="card-body">
                <!-- Search Box -->
                <div class="mb-3">
                    <input type="text" 
                           class="form-control" 
                           id="search_s" 
                           placeholder="ðŸ” Search by player name or team..."
                           autocomplete="off">
                    <small class="text-muted">Type to filter players â€¢ <span id="count_s">{{ pitchers.count }} available</span></small>
                </div>
                
                <select name="pick_s" id="pick_s" class="form-select form-select-lg" required>
                    <option value="">-- Select a Pitcher --</option>
                    {% for player in pitchers %}
                        <option value="{{ player.id }}"
                                data-name="{{ player.full_name|lower }}"
                                data-team="{{ player.team_name|lower }}"
                                {% if existing_picks.pick_s == player.id %}selected{% endif %}>
                            {{ player.full_name }} - {{ player.team_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Submit Buttons -->
        <div class="row mt-4 mb-5">
            <div class="col-md-6 mb-2">
                <button type="submit" class="btn btn-primary btn-lg w-100">
                    <i class="fas fa-save"></i> Save My Picks
                </button>
            </div>
            <div class="col-md-6 mb-2">
                <a href="{% url 'home' %}" class="btn btn-secondary btn-lg w-100">
                    <i class="fas fa-times"></i> Cancel
                </a>
            </div>
        </div>
    </form>
</div>

<script>
// Countdown Timer
const deadline = new Date('{{ week.deadline_utc|date:"c" }}').getTime();

function updateCountdown() {
    const now = new Date().getTime();
    const distance = deadline - now;
    
    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
    
    const countdownElement = document.getElementById('countdown-timer');
    const alertElement = document.getElementById('countdown-alert');
    const submitButton = document.querySelector('button[type="submit"]');
    
    if (distance < 0) {
        // Deadline passed
        countdownElement.innerHTML = 'DEADLINE PASSED';
        countdownElement.className = 'badge bg-danger fs-6';
        alertElement.className = 'alert alert-danger';
        
        // Disable form
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-lock"></i> Picks Locked';
        
        // Disable all selects and search boxes
        document.querySelectorAll('select, input[type="text"]').forEach(el => {
            el.disabled = true;
        });
    } else if (distance < 3600000) {
        // Less than 1 hour - urgent
        countdownElement.innerHTML = `${minutes}m ${seconds}s`;
        countdownElement.className = 'badge bg-danger fs-6';
        alertElement.className = 'alert alert-danger';
    } else if (distance < 86400000) {
        // Less than 1 day - warning
        countdownElement.innerHTML = `${hours}h ${minutes}m ${seconds}s`;
        countdownElement.className = 'badge bg-warning text-dark fs-6';
        alertElement.className = 'alert alert-warning';
    } else {
        // More than 1 day - normal
        if (days > 0) {
            countdownElement.innerHTML = `${days}d ${hours}h ${minutes}m`;
        } else {
            countdownElement.innerHTML = `${hours}h ${minutes}m ${seconds}s`;
        }
        countdownElement.className = 'badge bg-primary fs-6';
        alertElement.className = 'alert alert-info';
    }
}

// Update countdown every second
updateCountdown();
setInterval(updateCountdown, 1000);

// Player Search/Filter Function
function setupSearch(searchInputId, selectId, countId) {
    const searchInput = document.getElementById(searchInputId);
    const select = document.getElementById(selectId);
    const countSpan = document.getElementById(countId);
    const options = Array.from(select.options);
    
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        let visibleCount = 0;
        
        options.forEach(option => {
            if (option.value === '') {
                // Keep the placeholder option
                option.style.display = '';
                return;
            }
            
            const playerName = option.getAttribute('data-name') || '';
            const teamName = option.getAttribute('data-team') || '';
            
            if (playerName.includes(searchTerm) || teamName.includes(searchTerm)) {
                option.style.display = '';
                visibleCount++;
            } else {
                option.style.display = 'none';
            }
        });
        
        // Update count
        if (searchTerm) {
            countSpan.textContent = `${visibleCount} found`;
            countSpan.parentElement.className = 'text-success';
        } else {
            countSpan.textContent = `${visibleCount} available`;
            countSpan.parentElement.className = 'text-muted';
        }
    });
    
    // Clear search when selection is made
    select.addEventListener('change', function() {
        if (this.value) {
            searchInput.value = '';
            searchInput.dispatchEvent(new Event('input'));
        }
    });
}

// Form validation
document.addEventListener('DOMContentLoaded', function() {
    // Set up search for all categories
    setupSearch('search_2b', 'pick_2b', 'count_2b');
    setupSearch('search_hr', 'pick_hr', 'count_hr');
    setupSearch('search_swp', 'pick_swp', 'count_swp');
    setupSearch('search_s', 'pick_s', 'count_s');
    
    const form = document.querySelector('form');
    const selects = {
        pick2b: document.getElementById('pick_2b'),
        pickHr: document.getElementById('pick_hr'),
        pickSwp: document.getElementById('pick_swp'),
        pickS: document.getElementById('pick_s')
    };
    
    // Add change event listeners for visual feedback
    Object.values(selects).forEach(select => {
        select.addEventListener('change', function() {
            if (this.value) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } else {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
            }
        });
    });
    
    form.addEventListener('submit', function(e) {
        let isValid = true;
        let errorMessage = '';
        
        // Check all picks selected
        Object.entries(selects).forEach(([key, select]) => {
            if (!select.value) {
                isValid = false;
                select.classList.add('is-invalid');
                errorMessage = 'Please select all 4 picks before submitting.';
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            alert(errorMessage);
            return false;
        }
        
        // Optional: Check for duplicates
        const values = Object.values(selects).map(s => s.value);
        const uniqueValues = new Set(values);
        
        // Uncomment to enforce no duplicate players
        // if (values.length !== uniqueValues.size) {
        //     e.preventDefault();
        //     alert('You cannot select the same player for multiple categories.');
        //     return false;
        // }
        
        // Confirm submission
        const confirmMsg = 'Are you sure you want to submit these picks?\n\n' +
            `2 Hits: ${selects.pick2b.options[selects.pick2b.selectedIndex].text}\n` +
            `Home Run: ${selects.pickHr.options[selects.pickHr.selectedIndex].text}\n` +
            `Starting Winning Pitcher: ${selects.pickSwp.options[selects.pickSwp.selectedIndex].text}\n` +
            `Save: ${selects.pickS.options[selects.pickS.selectedIndex].text}\n\n` +
            'You can edit these picks before the deadline.';
        
        return confirm(confirmMsg);
    });
});
</script>
{% endblock %}
