{% extends 'base.html' %}
{% load humanize %}

{% block title %}Payment Portal - Baseball Pick 4{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Account Balance Card -->
    <div class="card border-primary mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="card-title mb-2">
                        <i class="fas fa-wallet text-primary"></i> Account Balance
                    </h5>
                    <h2 class="text-primary mb-0">${{ user.profile.account_balance|floatformat:2 }}</h2>
                    {% if user.profile.account_balance < user.profile.low_balance_threshold %}
                    <small class="text-warning">
                        <i class="fas fa-exclamation-triangle"></i> Balance below ${{ user.profile.low_balance_threshold }}
                    </small>
                    {% endif %}
                </div>
                <div class="col-md-6 text-md-end mt-3 mt-md-0">
                    <button class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#withdrawModal">
                        <i class="fas fa-arrow-up"></i> Withdraw
                    </button>
                    <a href="{% url 'transaction_history' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-history"></i> Transaction History
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <h2 class="mb-4">
                <i class="fas fa-credit-card"></i> Payment Portal
            </h2>

            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Payment Summary Card -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Payment Summary</h5>
                </div>
                <div class="card-body">
                    {% if current_week %}
                        <p class="mb-2">
                            <strong>Current Week:</strong> Week {{ current_week.week_number }}
                            ({{ current_week.start_date|date:"M d" }} - {{ current_week.end_date|date:"M d, Y" }})
                        </p>
                        <p class="mb-2">
                            <strong>Payment Deadline:</strong>
                            {{ current_week.deadline_utc|date:"D, M d, Y g:i A T" }}
                        </p>
                    {% else %}
                        <p class="text-muted mb-0">No active week at this time.</p>
                    {% endif %}

                    <hr>

                    <h4 class="mb-0">
                        Total Outstanding:
                        <span class="text-{% if total_outstanding > 0 %}danger{% else %}success{% endif %}">
                            ${{ total_outstanding|floatformat:2 }}
                        </span>
                    </h4>
                </div>
            </div>

            <!-- Team Payments -->
            <div class="row">
                {% for item in payment_data %}
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">{{ item.team.name }}</h5>
                            </div>
                            <div class="card-body">
                                <p class="mb-2">
                                    <strong>Weekly Fee:</strong> ${{ item.team.weekly_fee|floatformat:2 }}
                                </p>
                                <p class="mb-3">
                                    <strong>Amount Due:</strong>
                                    <span class="text-danger fs-4">${{ item.amount_due|floatformat:2 }}</span>
                                </p>

                                {% if item.status == 'paid' %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check-circle"></i> Paid
                                    </span>
                                {% elif item.status == 'outstanding' and item.week %}
                                    {% if user.profile.account_balance >= item.team.weekly_fee %}
                                    <button class="btn btn-success btn-sm me-2" onclick="payWithBalance('{{ item.team.id }}', '{{ item.week.id }}')">
                                        <i class="fas fa-wallet"></i> Pay with Balance (${{ user.profile.account_balance|floatformat:2 }})
                                    </button>
                                    {% else %}
                                    <p class="text-muted mb-2">
                                        <i class="fas fa-info-circle"></i> Add ${{ item.team.weekly_fee|floatformat:2 }} to your balance to pay instantly
                                    </p>
                                    {% endif %}
                                    <button class="btn btn-primary btn-sm"
                                            onclick="payWithCard('{{ item.team.id }}', '{{ item.week.id }}', '{{ item.team.weekly_fee }}', '{{ item.team.name }}')">
                                        <i class="fas fa-credit-card"></i> Pay with Card
                                    </button>
                                {% elif item.status == 'no_active_week' %}
                                    <div class="alert alert-info mb-0">
                                        <i class="fas fa-info-circle"></i> No active week - payments will be available when the next week begins
                                    </div>
                                {% else %}
                                    <div class="alert alert-warning mb-0">
                                        <i class="fas fa-exclamation-triangle"></i> Payment status: {{ item.status }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> You are not a member of any teams yet.
                            <a href="{% url 'join_team' %}" class="alert-link">Join a team</a> to start playing!
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- Payment History Link -->
            <div class="text-center mt-4">
                <a href="{% url 'payment_history' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-history"></i> View Payment History
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">
                    <i class="fas fa-credit-card"></i> Complete Payment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Payment Info -->
                <div class="alert alert-info mb-3">
                    <div class="row">
                        <div class="col-6">
                            <strong>Team:</strong><br>
                            <span id="modal-team-name"></span>
                        </div>
                        <div class="col-6 text-end">
                            <strong>Amount:</strong><br>
                            <span class="fs-4 text-primary">$<span id="modal-amount"></span></span>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="payment-loading" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Initializing payment form...</p>
                </div>

                <!-- Payment Form -->
                <form id="payment-form" style="display: none;">
                    <!-- Stripe Payment Element will be inserted here -->
                    <div id="payment-element" class="mb-3"></div>

                    <!-- Error Display -->
                    <div id="payment-errors" class="alert alert-danger" role="alert" style="display: none;"></div>

                    <!-- Submit Button -->
                    <button id="submit-payment" class="btn btn-primary w-100" type="submit">
                        <span id="button-text">
                            <i class="fas fa-lock"></i> Pay Securely
                        </span>
                        <span id="button-spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                    </button>

                    <p class="text-muted small mt-2 text-center">
                        <i class="fas fa-shield-alt"></i> Secured by Stripe
                    </p>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Withdrawal Modal -->
<div class="modal fade" id="withdrawModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Withdraw Funds</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Available Balance: <strong>${{ user.profile.account_balance|floatformat:2 }}</strong></p>
                <p class="text-muted small">Minimum withdrawal: $5.00</p>

                <form id="withdrawalForm">
                    <div class="mb-3">
                        <label class="form-label">Amount ($)</label>
                        <input type="number" class="form-control" id="withdrawAmount"
                               step="0.01" min="5" max="{{ user.profile.account_balance }}" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Withdrawal Method</label>
                        <select class="form-select" id="withdrawMethod" required>
                            <option value="">Choose...</option>
                            {% if user.profile.stripe_customer_id %}
                            <option value="stripe">Bank Transfer (Stripe)</option>
                            {% endif %}
                            {% if user.profile.paypal_email %}
                            <option value="paypal">PayPal ({{ user.profile.paypal_email }})</option>
                            {% endif %}
                            {% if user.profile.venmo_username %}
                            <option value="venmo">Venmo (@{{ user.profile.venmo_username }})</option>
                            {% endif %}
                        </select>
                        <small class="text-muted">
                            Configure payment methods in <a href="{% url 'account_settings' %}">Account Settings</a>
                        </small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="withdrawNotes" rows="2"></textarea>
                    </div>
                </form>

                <div id="withdrawalMessage" class="alert d-none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitWithdrawal()">
                    Request Withdrawal
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>

<script>
// Initialize Stripe
const stripe = Stripe('{{ stripe_public_key }}');
let elements;
let paymentElement;
let currentTeamId;
let currentWeekId;
let paymentInProgress = false;  // Prevent double-clicks

// CSRF Token Helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Pay with Balance Function
async function payWithBalance(teamId, weekId) {
    if (!confirm('Pay with your account balance?')) return;

    try {
        const response = await fetch('/payments/pay-with-balance/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                team_id: teamId,
                week_id: weekId
            })
        });

        const data = await response.json();

        if (data.success) {
            alert('Payment successful! New balance: $' + data.new_balance);
            window.location.reload();
        } else {
            alert('Payment failed: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Payment error:', error);
        alert('Payment error: ' + error.message);
    }
}

// Pay with Card Function - WITH DUPLICATE PREVENTION
async function payWithCard(teamId, weekId, amount, teamName) {
    // Prevent multiple simultaneous payment attempts
    if (paymentInProgress) {
        alert('Payment is already being processed. Please wait.');
        return;
    }

    paymentInProgress = true;
    currentTeamId = teamId;
    currentWeekId = weekId;

    try {
        // Update modal info
        document.getElementById('modal-team-name').textContent = teamName;
        document.getElementById('modal-amount').textContent = parseFloat(amount).toFixed(2);

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
        modal.show();

        // Show loading state
        document.getElementById('payment-loading').style.display = 'block';
        document.getElementById('payment-form').style.display = 'none';

        // Create payment intent
        const response = await fetch(`/api/payments/create-intent/${teamId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            }
        });

        const data = await response.json();

        if (!response.ok) {
            // Handle specific error cases
            if (response.status === 400 && data.error.includes('already paid')) {
                // User already paid - show message and reload
                showError(data.error);
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                return;
            }

            throw new Error(data.error || 'Failed to initialize payment');
        }

        // Initialize Stripe Elements with the client secret
        const appearance = {
            theme: 'stripe',
            variables: {
                colorPrimary: '#0d6efd',
            }
        };

        elements = stripe.elements({
            clientSecret: data.clientSecret,
            appearance: appearance
        });

        // Create and mount the Payment Element
        paymentElement = elements.create('payment');
        paymentElement.mount('#payment-element');

        // Hide loading, show form
        document.getElementById('payment-loading').style.display = 'none';
        document.getElementById('payment-form').style.display = 'block';

    } catch (error) {
        console.error('Error initializing payment:', error);
        showError(error.message || 'Failed to initialize payment form');
        document.getElementById('payment-loading').style.display = 'none';

        // Close modal on error
        setTimeout(() => {
            const modalElement = document.getElementById('paymentModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) modal.hide();
        }, 3000);
    } finally {
        // Always reset the flag when done (success or error)
        paymentInProgress = false;
    }
}

// Handle form submission
document.getElementById('payment-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    setLoading(true);
    hideError();

    try {
        // Confirm the payment with Stripe
        const {error} = await stripe.confirmPayment({
            elements,
            confirmParams: {
                return_url: window.location.origin + '/payments/',
            },
        });

        if (error) {
            // Payment failed - show error
            showError(error.message);
            setLoading(false);
        } else {
            // Payment succeeded - Stripe will redirect to return_url
            // The webhook will handle updating the database
        }
    } catch (error) {
        console.error('Payment error:', error);
        showError('An unexpected error occurred');
        setLoading(false);
    }
});

// UI Helper Functions
function setLoading(isLoading) {
    const submitButton = document.getElementById('submit-payment');
    const buttonText = document.getElementById('button-text');
    const buttonSpinner = document.getElementById('button-spinner');

    if (isLoading) {
        submitButton.disabled = true;
        buttonText.style.display = 'none';
        buttonSpinner.style.display = 'inline-block';
    } else {
        submitButton.disabled = false;
        buttonText.style.display = 'inline';
        buttonSpinner.style.display = 'none';
    }
}

function showError(message) {
    const errorDiv = document.getElementById('payment-errors');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
}

function hideError() {
    const errorDiv = document.getElementById('payment-errors');
    errorDiv.style.display = 'none';
}

// Withdrawal Function (placeholder)
function submitWithdrawal() {
    alert('Withdrawal feature coming soon!');
}
</script>
{% endblock %}
